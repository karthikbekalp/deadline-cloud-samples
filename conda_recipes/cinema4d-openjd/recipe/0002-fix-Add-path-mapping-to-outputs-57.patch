From 056f5ea931b78eea0e21024e192179c7f5d871d8 Mon Sep 17 00:00:00 2001
From: evanspearman-a <67653527+evanspearman-a@users.noreply.github.com>
Date: Fri, 5 Jul 2024 12:41:01 -0500
Subject: [PATCH] fix: Add path mapping to outputs (#57)

Signed-off-by: Evan Spearman <evans@amazon.com>
---
 .../Cinema4DClient/cinema4d_client.py           |  2 +-
 .../Cinema4DClient/cinema4d_handler.py          | 17 +++++++++++++++--
 2 files changed, 16 insertions(+), 3 deletions(-)

diff --git a/src/deadline/cinema4d_adaptor/Cinema4DClient/cinema4d_client.py b/src/deadline/cinema4d_adaptor/Cinema4DClient/cinema4d_client.py
index bd18aad..9a5d80e 100644
--- a/src/deadline/cinema4d_adaptor/Cinema4DClient/cinema4d_client.py
+++ b/src/deadline/cinema4d_adaptor/Cinema4DClient/cinema4d_client.py
@@ -19,7 +19,7 @@ class Cinema4DClient(ClientInterface):
 
     def __init__(self, server_path: str) -> None:
         super().__init__(server_path=server_path)
-        self.actions.update(Cinema4DHandler().action_dict)
+        self.actions.update(Cinema4DHandler(lambda path: self.map_path(path)).action_dict)
 
     def close(self, args: Optional[dict] = None) -> None:
         sys.exit(0)
diff --git a/src/deadline/cinema4d_adaptor/Cinema4DClient/cinema4d_handler.py b/src/deadline/cinema4d_adaptor/Cinema4DClient/cinema4d_handler.py
index 625996a..96784a3 100644
--- a/src/deadline/cinema4d_adaptor/Cinema4DClient/cinema4d_handler.py
+++ b/src/deadline/cinema4d_adaptor/Cinema4DClient/cinema4d_handler.py
@@ -1,7 +1,7 @@
 # Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 from __future__ import annotations
 
-import os as os
+import os
 from typing import Any, Callable, Dict
 
 try:
@@ -19,8 +19,9 @@ def progress_callback(progress, progress_type):
 class Cinema4DHandler:
     action_dict: Dict[str, Callable[[Dict[str, Any]], None]] = {}
     render_kwargs: Dict[str, Any]
+    map_path: Callable[[str], str]
 
-    def __init__(self) -> None:
+    def __init__(self, map_path: Callable[[str], str]) -> None:
         """
         Constructor for the c4dpy handler. Initializes action_dict and render variables
         """
@@ -32,6 +33,7 @@ class Cinema4DHandler:
         }
         self.render_kwargs = {}
         self.take = "Main"
+        self.map_path = map_path
 
     def start_render(self, data: dict) -> None:
         self.doc = c4d.documents.GetActiveDocument()
@@ -42,6 +44,17 @@ class Cinema4DHandler:
         self.render_data[c4d.RDATA_FRAMEFROM] = c4d.BaseTime(frame, fps)
         self.render_data[c4d.RDATA_FRAMETO] = c4d.BaseTime(frame, fps)
         self.render_data[c4d.RDATA_FRAMESTEP] = 1
+
+        if self.render_data[c4d.RDATA_PATH]:
+            self.render_data[c4d.RDATA_PATH] = self.map_path(self.render_data[c4d.RDATA_PATH])
+        if (
+            self.render_data[c4d.RDATA_MULTIPASS_SAVEIMAGE]
+            and self.render_data[c4d.RDATA_MULTIPASS_FILENAME]
+        ):
+            self.render_data[c4d.RDATA_MULTIPASS_FILENAME] = self.map_path(
+                self.render_data[c4d.RDATA_MULTIPASS_FILENAME]
+            )
+
         bm = bitmaps.MultipassBitmap(
             int(self.render_data[c4d.RDATA_XRES]),
             int(self.render_data[c4d.RDATA_YRES]),
-- 
2.40.1.windows.1

